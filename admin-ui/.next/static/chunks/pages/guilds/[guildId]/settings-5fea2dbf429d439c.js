(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[882],{5162:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/guilds/[guildId]/settings",function(){return n(9594)}])},4166:function(e,t,n){"use strict";n.d(t,{Z:function(){return u}});var a=n(4246),s=n(9894),l=n.n(s),r=n(6677),i=n(7378),o=n(6e3),c=n(5682);let d=[{href:e=>"/guilds/".concat(e),label:"Dashboard"},{href:e=>"/guilds/".concat(e,"/settings"),label:"Club Settings"},{href:e=>"/guilds/".concat(e,"/channels"),label:"Channels"},{href:e=>"/guilds/".concat(e,"/personality"),label:"Personality"},{href:e=>"/guilds/".concat(e,"/corrections"),label:"Corrections"},{href:e=>"/guilds/".concat(e,"/rescan"),label:"Rescan User"},{href:e=>"/guilds/".concat(e,"/usage"),label:"Usage"}];function u(e){var t;let{guildId:n,children:s,title:u}=e,h=(0,r.useRouter)(),p=(0,c.h)(),{user:g,refresh:m}=(0,o.k)(),f=(0,i.useMemo)(()=>n?d.map(e=>{let t=e.href(n);return{...e,href:t,active:h.pathname===t}}):[],[n,h.asPath]);return(0,a.jsxs)("div",{className:"layout",children:[(0,a.jsxs)("aside",{className:"sidebar",children:[(0,a.jsxs)("div",{style:{marginBottom:32},children:[(0,a.jsx)("h1",{style:{margin:0,fontSize:22,fontWeight:700},children:"Slimy Admin"}),g&&(0,a.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[(0,a.jsxs)("span",{style:{opacity:.8,fontSize:14},children:[g.username," \xb7 ",null===(t=g.role)||void 0===t?void 0:t.toUpperCase()]}),(0,a.jsx)("button",{className:"btn outline",onClick:async()=>{try{await p("/api/auth/logout",{method:"POST"}),await m()}catch(e){console.error(e)}},children:"Logout"})]})]}),n?(0,a.jsx)("nav",{style:{display:"flex",flexDirection:"column",gap:8},children:f.map(e=>(0,a.jsx)(l(),{href:e.href,legacyBehavior:!0,children:(0,a.jsx)("a",{style:{padding:"10px 12px",borderRadius:8,background:h.asPath===e.href?"rgba(56, 189, 248, 0.15)":"transparent",border:h.asPath===e.href?"1px solid rgba(56, 189, 248, 0.4)":"1px solid transparent"},children:e.label})},e.href))}):(0,a.jsx)("p",{style:{opacity:.7},children:"Select a guild to begin."})]}),(0,a.jsxs)("main",{className:"content",children:[u&&(0,a.jsx)("h2",{style:{marginTop:0,marginBottom:24},children:u}),s]})]})}},5682:function(e,t,n){"use strict";n.d(t,{S:function(){return l},h:function(){return r}});var a=n(7378),s=n(6e3);async function l(e){let{method:t="GET",body:n,csrfToken:a}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=new Headers;!n||n instanceof FormData||s.set("Content-Type","application/json"),a&&t&&"GET"!==t&&s.set("x-csrf-token",a);let l=await fetch("".concat("http://localhost:3080").concat(e),{method:t,body:n?n instanceof FormData?n:JSON.stringify(n):void 0,credentials:"include",headers:s});if(204===l.status)return null;let r=(l.headers.get("content-type")||"").includes("application/json")?await l.json():await l.text();if(!l.ok)throw Error((null==r?void 0:r.error)||(null==r?void 0:r.message)||"HTTP ".concat(l.status));return r}function r(){let{csrfToken:e}=(0,s.k)();return(0,a.useCallback)(function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return l(t,{...n,csrfToken:e})},[e])}},4842:function(e,t,n){"use strict";n.d(t,{O:function(){return l},S:function(){return r}});let a="http://localhost:3080";function s(e){if("string"!=typeof e)return e;try{return JSON.parse(e)}catch(t){return e}}async function l(e){let{guildId:t,taskName:n,body:s={},csrfToken:l,onEvent:i}=e,o=new Headers;o.set("Content-Type","application/json"),l&&o.set("x-csrf-token",l);let c=await fetch("".concat(a,"/api/guilds/").concat(t,"/tasks/").concat(n),{method:"POST",credentials:"include",headers:o,body:JSON.stringify(s)});if(!c.ok)throw Error("Failed to start task (".concat(c.status,")"));let{taskId:d}=await c.json();if(!d)throw Error("Task did not return a taskId");return i&&i({event:"start",data:{taskId:d}}),r(d,{onEvent:i})}function r(e){let{onEvent:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(n=>{let l=!1,r=new EventSource("".concat(a,"/api/tasks/").concat(e,"/stream"),{withCredentials:!0}),i=()=>{r.close()};r.addEventListener("log",e=>{let n=s(e.data);t&&t({event:"log",data:n})}),r.addEventListener("error",e=>{let a=s(e.data);a&&t&&t({event:"error",data:a}),r.readyState===EventSource.CLOSED&&(i(),n({status:"closed"}))}),r.addEventListener("end",e=>{let a=s(e.data);t&&t({event:"end",data:a}),i(),l||(l=!0,n(a))}),r.onerror=()=>{r.readyState!==EventSource.CLOSED||(i(),l||(l=!0,n({status:"closed"})))}})}},9594:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return h}});var a=n(4246),s=n(7378),l=n(6677),r=n(9720),i=n(4166),o=n(5682),c=n(6e3),d=n(4842);let u=e=>(0,o.S)(e);function h(){var e,t;let{guildId:n}=(0,l.useRouter)().query,h=(0,o.h)(),{user:p}=(0,c.k)(),{data:g,mutate:m}=(0,r.ZP)(n?"/api/guilds/".concat(n,"/settings"):null,u),{data:f,mutate:y}=(0,r.ZP)((null==p?void 0:p.role)==="owner"?"/api/backup/list":null,o.S),[x,v]=(0,s.useState)(""),[j,b]=(0,s.useState)(""),[S,w]=(0,s.useState)(""),[k,T]=(0,s.useState)(""),[N,C]=(0,s.useState)(""),[E,L]=(0,s.useState)(null),[P,O]=(0,s.useState)(null),[D,B]=(0,s.useState)([]),[_,M]=(0,s.useState)(!1);if(!g)return(0,a.jsx)(i.Z,{guildId:n,title:"Club Settings",children:(0,a.jsx)("p",{children:"Loading settings…"})});let W=async e=>{e.preventDefault(),L("Saving…");try{let e={sheetUrl:x||g.sheetUrl||null,weekWindowDays:j?Number(j):null,thresholds:{warnLow:S?Number(S):null,warnHigh:k?Number(k):null},tokensPerMinute:N?Number(N):null,testSheet:!0},t=await h("/api/guilds/".concat(n,"/settings"),{method:"PUT",body:e});await m(t,{revalidate:!1}),L("Saved")}catch(e){L("Error: ".concat(e.message))}},U=(0,s.useMemo)(()=>"http://localhost:3080",[]),H=n?"".concat(U,"/api/guilds/").concat(n,"/export"):null,I=p&&("admin"===p.role||"owner"===p.role),R=(null==p?void 0:p.role)==="owner",V=async()=>{if(R&&!_)try{M(!0),B([]),O("Starting MySQL dump…");let e=await h("/api/backup/mysql-dump",{method:"POST",body:{}});O("Backup started (".concat(e.filename,")")),await (0,d.S)(e.taskId,{onEvent:e=>{var t,n;if("log"===e.event){let t=e.data.stream||"log";B(n=>[...n,"".concat(t,": ").concat(e.data.line)])}if("error"===e.event){let n=(null===(t=e.data)||void 0===t?void 0:t.message)||"Backup error";B(e=>[...e,"stderr: ".concat(n)]),O("Backup error: ".concat(n))}if("end"===e.event){let t=(null===(n=e.data)||void 0===n?void 0:n.status)||"completed";O("completed"===t?"Backup completed":"Backup ended with errors")}}}),await (null==y?void 0:y())}catch(e){O("Backup failed: ".concat(e.message)),B(t=>[...t,"stderr: ".concat(e.message)])}finally{M(!1)}};(0,s.useEffect)(()=>{R&&(null==y||y())},[R,y]);let F=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{style:{marginBottom:8},children:e}),0===t.length?(0,a.jsx)("p",{style:{opacity:.7},children:"No files found."}):(0,a.jsx)("ul",{style:{paddingLeft:18},children:t.slice(0,5).map(e=>(0,a.jsxs)("li",{style:{marginBottom:4},children:[(0,a.jsx)("code",{children:e.name}),(0,a.jsx)("span",{style:{opacity:.7,marginLeft:8},children:new Date(e.mtime).toLocaleString()})]},e.path))})]})};return(0,a.jsxs)(i.Z,{guildId:n,title:"Club Settings",children:[(0,a.jsxs)("form",{onSubmit:W,className:"card",style:{maxWidth:520},children:[(0,a.jsx)("label",{children:"Sheet URL"}),(0,a.jsx)("input",{className:"input",placeholder:"https://docs.google.com/spreadsheets/d/...",defaultValue:g.sheetUrl||"",onChange:e=>v(e.target.value)}),(0,a.jsx)("label",{style:{marginTop:18},children:"Week Window (days)"}),(0,a.jsx)("input",{className:"input",type:"number",min:"1",max:"14",placeholder:"7",defaultValue:g.weekWindowDays||"",onChange:e=>b(e.target.value)}),(0,a.jsxs)("div",{style:{display:"flex",gap:12,marginTop:18},children:[(0,a.jsxs)("div",{style:{flex:1},children:[(0,a.jsx)("label",{children:"Warn Low"}),(0,a.jsx)("input",{className:"input",type:"number",defaultValue:(null===(e=g.thresholds)||void 0===e?void 0:e.warnLow)||"",onChange:e=>w(e.target.value)})]}),(0,a.jsxs)("div",{style:{flex:1},children:[(0,a.jsx)("label",{children:"Warn High"}),(0,a.jsx)("input",{className:"input",type:"number",defaultValue:(null===(t=g.thresholds)||void 0===t?void 0:t.warnHigh)||"",onChange:e=>T(e.target.value)})]})]}),(0,a.jsx)("label",{style:{marginTop:18},children:"OpenAI TPM"}),(0,a.jsx)("input",{className:"input",type:"number",placeholder:"60000",defaultValue:g.tokensPerMinute||"",onChange:e=>C(e.target.value)}),(0,a.jsx)("button",{type:"submit",className:"btn",style:{marginTop:24},children:"Save Settings"}),E&&(0,a.jsx)("p",{style:{marginTop:12},children:E}),g.sheetTest&&(0,a.jsxs)("p",{style:{marginTop:12,opacity:.8},children:["Sheet Test: ",g.sheetTest.ok?"OK (".concat(g.sheetTest.title,")"):g.sheetTest.error]})]}),I&&H&&(0,a.jsxs)("div",{className:"card",style:{marginTop:24},children:[(0,a.jsx)("h3",{style:{marginTop:0},children:"Exports"}),(0,a.jsx)("p",{style:{opacity:.7},children:"Download corrections or personality snapshots for offline review."}),(0,a.jsxs)("div",{style:{display:"flex",flexWrap:"wrap",gap:12},children:[(0,a.jsx)("a",{className:"btn outline",href:"".concat(H,"/corrections.csv"),children:"Corrections CSV"}),(0,a.jsx)("a",{className:"btn outline",href:"".concat(H,"/corrections.json"),children:"Corrections JSON"}),(0,a.jsx)("a",{className:"btn outline",href:"".concat(H,"/personality.json"),children:"Personality JSON"})]})]}),R&&(0,a.jsxs)("div",{className:"card",style:{marginTop:24},children:[(0,a.jsx)("h3",{style:{marginTop:0},children:"Backups"}),(0,a.jsxs)("p",{style:{opacity:.7},children:["Trigger an immediate MySQL dump and export of corrections/personality. Files store under",(0,a.jsx)("code",{style:{marginLeft:4},children:"/var/backups/slimy"}),"."]}),(0,a.jsx)("button",{className:"btn",type:"button",disabled:_,onClick:V,children:_?"Backup running…":"Trigger MySQL Dump"}),P&&(0,a.jsx)("p",{style:{marginTop:12},children:P}),(0,a.jsx)("div",{style:{marginTop:16,background:"rgba(15,23,42,0.6)",border:"1px solid rgba(148,163,184,0.2)",borderRadius:8,padding:12,fontFamily:"monospace",fontSize:12,maxHeight:200,overflowY:"auto"},children:0===D.length?(0,a.jsx)("p",{style:{opacity:.7},children:"No backup logs yet."}):D.map((e,t)=>(0,a.jsx)("div",{children:e},t))}),f&&(0,a.jsxs)("div",{style:{marginTop:20,display:"grid",gap:12},children:[F("MySQL dumps",f.mysql),F("Data exports",f.data)]})]})]})}}},function(e){e.O(0,[827,720,888,774,179],function(){return e(e.s=5162)}),_N_E=e.O()}]);