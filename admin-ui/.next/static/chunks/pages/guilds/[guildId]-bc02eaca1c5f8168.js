(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[443],{1110:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/guilds/[guildId]",function(){return a(7284)}])},9087:function(e,t,a){"use strict";a.d(t,{Z:function(){return d}});var l=a(5893),s=a(7294),n=a(6976),r=a(7751);let i=e=>(0,r.SC)(e);function d(e){let{guildId:t}=e,a=(0,r.h_)(),{data:d,mutate:c}=(0,n.ZP)(t?"/api/guilds/".concat(t,"/corrections"):null,i),[o,u]=(0,s.useState)({displayName:"",metric:"total",value:"",reason:""}),[h,p]=(0,s.useState)(null),[m,g]=(0,s.useState)(""),x=(0,s.useMemo)(()=>(function(e){if(null==e)return null;let t=String(e).trim();if(!t)return null;let a=t.match(/^([\d,.]+)([kmb])$/i);if(a){let e=Number(a[1].replace(/,/g,"")),t=a[2].toLowerCase();return Number.isFinite(e)?e*("k"===t?1e3:"m"===t?1e6:1e9):null}let l=Number(t.replace(/,/g,""));return Number.isFinite(l)?l:null})(o.value),[o.value]),y=async e=>{e.preventDefault(),p("Saving…");try{await a("/api/guilds/".concat(t,"/corrections"),{method:"POST",body:o}),u({displayName:"",metric:o.metric,value:"",reason:""}),await c(),p("Added correction")}catch(e){p(e.message)}},v=async e=>{try{await a("/api/guilds/".concat(t,"/corrections/").concat(e),{method:"DELETE"}),await c()}catch(e){p(e.message)}},j=async()=>{let e=m.split(/\r?\n/).map(e=>e.trim()).filter(Boolean);if(e.length){for(let l of e){let[e,s,n,r]=l.split(",").map(e=>e.trim());if(e&&s&&n)try{await a("/api/guilds/".concat(t,"/corrections"),{method:"POST",body:{displayName:e,metric:s,value:n,reason:r}})}catch(t){p("Failed to import ".concat(e,": ").concat(t.message));return}}await c(),g(""),p("CSV import complete")}};return(0,l.jsxs)("div",{style:{display:"grid",gap:16},children:[(0,l.jsx)("div",{className:"card",children:(0,l.jsxs)("form",{onSubmit:y,style:{display:"grid",gap:12},children:[(0,l.jsxs)("div",{style:{display:"flex",gap:12,flexWrap:"wrap"},children:[(0,l.jsx)("input",{className:"input",placeholder:"Display Name",value:o.displayName,onChange:e=>u(t=>({...t,displayName:e.target.value}))}),(0,l.jsxs)("select",{className:"select",value:o.metric,onChange:e=>u(t=>({...t,metric:e.target.value})),children:[(0,l.jsx)("option",{value:"total",children:"Total"}),(0,l.jsx)("option",{value:"sim",children:"Sim"})]}),(0,l.jsx)("input",{className:"input",placeholder:"Value",value:o.value,onChange:e=>u(t=>({...t,value:e.target.value}))})]}),(0,l.jsx)("input",{className:"input",placeholder:"Reason (optional)",value:o.reason,onChange:e=>u(t=>({...t,reason:e.target.value}))}),(0,l.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:12,flexWrap:"wrap"},children:[(0,l.jsx)("button",{className:"btn",type:"submit",children:"Add Correction"}),(0,l.jsxs)("span",{style:{opacity:.7},children:["Preview: ",null!=x?x:"—"]}),h&&(0,l.jsx)("span",{children:h})]})]})}),(0,l.jsxs)("div",{className:"card",children:[(0,l.jsx)("h4",{style:{marginTop:0},children:"Batch CSV Import"}),(0,l.jsx)("textarea",{className:"textarea",placeholder:"displayName,metric,value,reason",value:m,onChange:e=>g(e.target.value)}),(0,l.jsx)("button",{className:"btn outline",style:{marginTop:12},onClick:j,children:"Import CSV"})]}),(0,l.jsx)("div",{className:"card",style:{overflowX:"auto"},children:(0,l.jsxs)("table",{className:"table",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"Member"}),(0,l.jsx)("th",{children:"Metric"}),(0,l.jsx)("th",{children:"Value"}),(0,l.jsx)("th",{children:"Reason"}),(0,l.jsx)("th",{children:"Source"}),(0,l.jsx)("th",{children:"Created"}),(0,l.jsx)("th",{})]})}),(0,l.jsx)("tbody",{children:((null==d?void 0:d.corrections)||[]).map(e=>(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:e.display_name}),(0,l.jsx)("td",{children:e.metric}),(0,l.jsx)("td",{children:Number(e.value).toLocaleString()}),(0,l.jsx)("td",{children:e.reason||"—"}),(0,l.jsx)("td",{children:e.source||"manual"}),(0,l.jsx)("td",{children:new Date(e.created_at).toLocaleString()}),(0,l.jsx)("td",{children:(0,l.jsx)("button",{className:"btn outline",type:"button",onClick:()=>v(e.id),children:"Delete"})})]},e.id))})]})})]})}},4167:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});var l=a(5893),s=a(7294),n=a(7751);function r(e){var t,a;let{guildId:r}=e,i=(0,n.h_)(),[d,c]=(0,s.useState)(null),[o,u]=(0,s.useState)(""),[h,p]=(0,s.useState)("auto"),[m,g]=(0,s.useState)(null),[x,y]=(0,s.useState)(null),v=async e=>{if(e.preventDefault(),!d||!o){y("File and member are required");return}let t=new FormData;t.append("file",d),t.append("member",o),t.append("metric",h),y("Uploading…");try{let e=await i("/api/guilds/".concat(r,"/rescan-user"),{method:"POST",body:t});g(e),y("Rescan complete")}catch(e){y(e.message),g(null)}};return(0,l.jsxs)("div",{style:{display:"grid",gap:16},children:[(0,l.jsxs)("form",{onSubmit:v,className:"card",style:{display:"grid",gap:16,maxWidth:540},children:[(0,l.jsx)("input",{type:"file",accept:"image/png,image/jpeg,image/webp",onChange:e=>{var t;return c((null===(t=e.target.files)||void 0===t?void 0:t[0])||null)}}),(0,l.jsx)("input",{className:"input",placeholder:"Display name",value:o,onChange:e=>u(e.target.value)}),(0,l.jsxs)("select",{className:"select",value:h,onChange:e=>p(e.target.value),children:[(0,l.jsx)("option",{value:"auto",children:"Auto"}),(0,l.jsx)("option",{value:"total",children:"Total"}),(0,l.jsx)("option",{value:"sim",children:"Sim"})]}),(0,l.jsx)("button",{className:"btn",type:"submit",children:"Upload & Parse"}),x&&(0,l.jsx)("p",{style:{margin:0},children:x})]}),m&&(0,l.jsxs)("div",{className:"card",style:{maxWidth:540},children:[(0,l.jsx)("h4",{style:{marginTop:0},children:"Result"}),(0,l.jsxs)("p",{children:[m.displayName," → ",Number(m.value).toLocaleString()," (",m.metric,")"]}),(0,l.jsxs)("p",{style:{opacity:.7},children:["Ensemble disagreements: ",null===(t=m.ensemble)||void 0===t?void 0:t.disagreements," / ",null===(a=m.ensemble)||void 0===a?void 0:a.totalMembers]})]})]})}},7284:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return C}});var l=a(5893),s=a(7294),n=a(1163),r=a(6976),i=a(5754),d=a(7751);let c=e=>(0,d.SC)(e);function o(e){let{guildId:t}=e,a=(0,d.h_)(),n=(0,s.useRef)(null),[i,o]=(0,s.useState)(null),[u,h]=(0,s.useState)(!1),{data:p,mutate:m,isLoading:g}=(0,r.ZP)(t?"/api/uploads/".concat(t):null,c),x=(0,s.useCallback)(async e=>{if(!e.length||!t)return;let l=new FormData;e.forEach(e=>l.append("files",e)),h(!0),o("Uploading ".concat(e.length," file").concat(e.length>1?"s":"","…"));try{var s;let n=await a("/api/uploads/".concat(t),{method:"POST",body:l}),r=null!==(s=null==n?void 0:n.uploaded)&&void 0!==s?s:e.length;o("Uploaded ".concat(r," file").concat(1===r?"":"s",".")),await m()}catch(e){o(e.message||"Upload failed")}finally{h(!1),n.current&&(n.current.value="")}},[a,t,m]),y=(null==p?void 0:p.items)||[];return(0,l.jsxs)("div",{style:{display:"grid",gap:16},children:[(0,l.jsx)("input",{ref:n,type:"file",accept:"image/png,image/jpeg,image/webp",multiple:!0,capture:"environment",style:{display:"none"},onChange:e=>{x(Array.from(e.target.files||[]))}}),(0,l.jsxs)("div",{className:"card",style:{display:"flex",alignItems:"center",gap:12,flexWrap:"wrap"},children:[(0,l.jsx)("button",{className:"btn".concat(u?" outline":""),type:"button",onClick:()=>{var e;return null===(e=n.current)||void 0===e?void 0:e.click()},disabled:u,children:u?"Uploading…":"Select Screenshots"}),(0,l.jsx)("button",{className:"btn outline",type:"button",disabled:g||u,onClick:()=>m(),children:"Refresh"}),i&&(0,l.jsx)("span",{style:{fontSize:13,opacity:.85},children:i})]}),g?(0,l.jsx)("div",{className:"card",style:{textAlign:"center",padding:"2rem"},children:"Loading uploads…"}):0===y.length?(0,l.jsx)("div",{className:"card",style:{textAlign:"center",padding:"2rem"},children:(0,l.jsx)("p",{style:{margin:0,opacity:.8},children:"No uploads yet. Drop screenshots here to get started."})}):(0,l.jsx)("div",{className:"card uploads-grid",style:{padding:16},children:y.map(e=>{var t,a,s,n,r;return(0,l.jsxs)("a",{href:(null===(t=e.urls)||void 0===t?void 0:t.large)||(null===(a=e.urls)||void 0===a?void 0:a.original)||"#",target:"_blank",rel:"noreferrer",style:{display:"flex",flexDirection:"column",textDecoration:"none",color:"inherit",gap:6},children:[(0,l.jsx)("img",{src:(null===(s=e.urls)||void 0===s?void 0:s.thumb)||(null===(n=e.urls)||void 0===n?void 0:n.large)||(null===(r=e.urls)||void 0===r?void 0:r.original),alt:"Upload thumbnail",style:{width:"100%",aspectRatio:"4 / 5",objectFit:"cover",borderRadius:10,border:"1px solid rgba(148, 163, 184, 0.18)",boxShadow:"0 8px 18px rgba(15, 23, 42, 0.4)"}}),(0,l.jsxs)("div",{style:{fontSize:12,opacity:.8},children:[e.uploadedBy&&(0,l.jsxs)("div",{style:{fontWeight:600,marginBottom:2},children:["Uploaded by ",e.uploadedBy]}),(0,l.jsx)("div",{style:{opacity:.7},children:new Date(e.uploadedAt).toLocaleString()})]})]},e.id)})})]})}var u=a(9087),h=a(4167);let p="Baseline (10-24-25)";function m(e){try{return new URL(e).toString()}catch(t){try{return new URL(e,"https://docs.google.com").toString()}catch(e){return null}}}function g(e){let t=function(e){let t=m(e);if(!t)return null;let a=new URL(t);return a.searchParams.has("widget")||a.searchParams.set("widget","true"),a.searchParams.has("headers")||a.searchParams.set("headers","false"),a.searchParams.has("single")||a.searchParams.set("single","true"),a.toString()}(e);return t?{type:"published",src:t}:null}function x(e){let t=m(e);if(!t)return null;let a=new URL(t),l=a.pathname.match(/\/d\/([a-zA-Z0-9-_]+)/);if(!l)return null;let s=new URL("/spreadsheets/d/".concat(l[1],"/pubhtml"),"https://docs.google.com"),n=a.searchParams.get("gid");return s.searchParams.set("widget","true"),s.searchParams.set("headers","false"),s.searchParams.set("single","true"),n&&s.searchParams.set("gid",n),{type:"document",src:s.toString()}}let y=e=>(0,d.SC)(e);function v(e){let{guildId:t}=e,{data:a,isLoading:s,error:n}=(0,r.ZP)(t?"/api/guilds/".concat(t,"/settings"):null,y),i=function(e){let t=g(null==e?void 0:e.sheetUrl)||x(null==e?void 0:e.sheetUrl);if(t)return{...t,reason:"settings"};let a=(null==e?void 0:e.sheetId)?x("https://docs.google.com/spreadsheets/d/".concat(e.sheetId,"/edit")):null;if(a)return{...a,reason:"settings"};let l=g("https://docs.google.com/spreadsheets/d/e/2PACX-1vR6WejkqqUB8bTWzi4mLolRQTYw5oMas70lR2um-gpB4YpVAHAFuEVL4tX7xKdx1Mxe7eWAEX-HzKX3/pubhtml?widget=true&headers=false&single=true");return l?{...l,reason:"fallback"}:null}(a),d=(null==i?void 0:i.src)||null;return(0,l.jsxs)("div",{style:{display:"grid",gap:20},children:[s?(0,l.jsx)("div",{className:"card",style:{padding:"2rem",textAlign:"center"},children:"Loading sheet…"}):n?(0,l.jsx)("div",{className:"card",style:{padding:"2rem",textAlign:"center"},children:"Failed to load guild settings."}):d?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"card",style:{padding:0,overflow:"hidden",minHeight:"60vh"},children:(0,l.jsx)("iframe",{title:"Current Sheet",src:d,style:{width:"100%",height:"70vh",border:"none"}})}),(null==i?void 0:i.reason)==="fallback"&&(0,l.jsxs)("p",{style:{fontSize:12,opacity:.75,margin:"-12px 0 0"},children:["Showing baseline sheet “",p,"” until the next data refresh."]})]}):(0,l.jsx)("div",{className:"card",style:{padding:"2rem"},children:(0,l.jsxs)("p",{style:{margin:0},children:["No Google Sheet configured for this guild yet. Add a sheet URL on the"," ",(0,l.jsx)("strong",{children:"Club Settings"})," page."]})}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{style:{margin:"0 0 12px"},children:"Corrections"}),(0,l.jsx)(u.Z,{guildId:t})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{style:{margin:"0 0 12px"},children:"Rescan Tools"}),(0,l.jsx)(h.Z,{guildId:t})]})]})}var j=a(2608);let f="http://172.19.0.1:3080";function b(e){if("string"!=typeof e)return e;try{return JSON.parse(e)}catch(t){return e}}async function S(e){let{guildId:t,taskName:a,body:l={},csrfToken:s,onEvent:n}=e,r=new Headers;r.set("Content-Type","application/json"),s&&r.set("x-csrf-token",s);let i=await fetch("".concat(f,"/api/guilds/").concat(t,"/tasks/").concat(a),{method:"POST",credentials:"include",headers:r,body:JSON.stringify(l)});if(!i.ok)throw Error("Failed to start task (".concat(i.status,")"));let{taskId:d}=await i.json();if(!d)throw Error("Task did not return a taskId");return n&&n({event:"start",data:{taskId:d}}),function(e){let{onEvent:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(a=>{let l=!1,s=new EventSource("".concat(f,"/api/tasks/").concat(e,"/stream"),{withCredentials:!0}),n=()=>{s.close()};s.addEventListener("log",e=>{let a=b(e.data);t&&t({event:"log",data:a})}),s.addEventListener("error",e=>{let l=b(e.data);l&&t&&t({event:"error",data:l}),s.readyState===EventSource.CLOSED&&(n(),a({status:"closed"}))}),s.addEventListener("end",e=>{let s=b(e.data);t&&t({event:"end",data:s}),n(),l||(l=!0,a(s))}),s.onerror=()=>{s.readyState!==EventSource.CLOSED||(n(),l||(l=!0,a({status:"closed"})))}})}(d,{onEvent:n})}let N=e=>(0,d.SC)(e),w=[{key:"dashboard",label:"Dashboard"},{key:"uploads",label:"Uploads"},{key:"sheet",label:"Current Sheet"}];function k(e){return null==e?"—":Number(e).toLocaleString()}function C(){var e,t,a,d,c;let u=function(e){if(e)return Array.isArray(e)?e[0]:e}((0,n.useRouter)().query.guildId),{csrfToken:h}=(0,j.k)(),{data:m,mutate:g}=(0,r.ZP)(u?"/api/guilds/".concat(u,"/health"):null,N,{refreshInterval:6e4}),{data:x}=(0,r.ZP)("/api/diag",N,{refreshInterval:6e4,revalidateOnFocus:!1}),[y,f]=(0,s.useState)("dashboard"),[b,C]=(0,s.useState)(null),[P,L]=(0,s.useState)([]),[T,E]=(0,s.useState)(null),[R,D]=(0,s.useState)(""),I=!!b,U=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(u&&h){C(e),L([]),E(null);try{await S({guildId:u,taskName:e,body:t,csrfToken:h,onEvent:t=>{var a,l;if("start"===t.event&&L(["task:".concat(e," started (id: ").concat(t.data.taskId||"unknown",")")]),"log"===t.event&&L(e=>[...e,"".concat(t.data.stream,": ").concat(t.data.line)]),"error"===t.event){let e=(null===(a=t.data)||void 0===a?void 0:a.message)||"Task error";L(t=>[...t,"stderr: ".concat(e)]),E({type:"error",message:e})}if("end"===t.event){let a=(null===(l=t.data)||void 0===l?void 0:l.status)||"completed";E({type:"completed"===a?"success":"error",message:"completed"===a?"".concat(e," completed"):"".concat(e," failed")})}}}),await g()}catch(e){E({type:"error",message:e.message})}finally{C(null)}}},A=(0,s.useMemo)(()=>u?"/guilds/".concat(u,"/usage"):"#",[u]),_=(null==x?void 0:x.uploads)||{today:0,total:0},z=null==x?void 0:null===(e=x.admin)||void 0===e?void 0:e.uptimeSec;return(0,l.jsxs)(i.Z,{guildId:u,title:"Guild Dashboard",children:[(0,l.jsx)("div",{style:{display:"flex",gap:8,marginBottom:24,flexWrap:"wrap"},children:w.map(e=>(0,l.jsx)("button",{onClick:()=>f(e.key),className:"btn ".concat(y===e.key?"":"outline"),children:e.label},e.key))}),"dashboard"===y&&(m?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"card-grid",children:[(0,l.jsxs)("div",{className:"card",children:[(0,l.jsx)("h4",{children:"Week"}),(0,l.jsx)("p",{style:{fontSize:24},children:m.weekId||"—"}),(0,l.jsxs)("p",{style:{opacity:.7},children:["Snapshot: ",m.lastSnapshotAt||"—"]})]}),(0,l.jsxs)("div",{className:"card",children:[(0,l.jsx)("h4",{children:"Members"}),(0,l.jsx)("p",{style:{fontSize:24},children:k(m.members)}),(0,l.jsxs)("p",{style:{opacity:.7},children:["Last sheet push: ",m.lastSheetPushAt||"—"]})]}),(0,l.jsxs)("div",{className:"card",children:[(0,l.jsx)("h4",{children:"Total Power"}),(0,l.jsx)("p",{style:{fontSize:24},children:k(m.totalPower)}),(0,l.jsxs)("p",{style:{opacity:.7},children:["Threshold ",k(null===(t=m.thresholds)||void 0===t?void 0:t.low)," – ",k(null===(a=m.thresholds)||void 0===a?void 0:a.high)]})]}),(0,l.jsxs)("div",{className:"card",children:[(0,l.jsx)("h4",{children:"Sim Power"}),(0,l.jsx)("p",{style:{fontSize:24},children:k(m.simPower)}),(0,l.jsx)("p",{children:(0,l.jsx)("a",{className:"pill",href:A,children:"Usage"})})]}),(0,l.jsxs)("div",{className:"card",children:[(0,l.jsx)("h4",{children:"Baseline Sheet"}),(0,l.jsx)("p",{style:{fontSize:18,marginBottom:8},children:p}),(0,l.jsx)("p",{style:{opacity:.75},children:"Dashboard metrics reference the baseline sheet until the next update."})]}),(0,l.jsxs)("div",{className:"card",children:[(0,l.jsx)("h4",{children:"Uploads"}),(0,l.jsxs)("p",{style:{fontSize:24},children:[k(_.today)," today"]}),(0,l.jsxs)("p",{style:{opacity:.7},children:["Total stored: ",k(_.total)]})]}),(0,l.jsxs)("div",{className:"card",children:[(0,l.jsx)("h4",{children:"API Uptime"}),(0,l.jsx)("p",{style:{fontSize:24},children:"number"==typeof z?"".concat(Math.floor(z/3600),"h"):"—"}),(0,l.jsxs)("p",{style:{opacity:.7},children:["Process ID: ",null!==(c=null==x?void 0:null===(d=x.admin)||void 0===d?void 0:d.pid)&&void 0!==c?c:"—"]})]})]}),(0,l.jsxs)("section",{style:{marginTop:40},children:[(0,l.jsx)("h3",{children:"Tasks"}),(0,l.jsxs)("div",{style:{display:"flex",gap:12,flexWrap:"wrap"},children:[(0,l.jsxs)("div",{className:"card",style:{flexBasis:"100%",background:"transparent",border:"none",padding:0},children:[(0,l.jsx)("label",{style:{display:"block",marginBottom:8},children:"Screenshot Directory"}),(0,l.jsxs)("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[(0,l.jsx)("input",{className:"input",placeholder:"/opt/slimy/app/screenshots/latest",value:R,onChange:e=>D(e.target.value),style:{flex:1,minWidth:220}}),(0,l.jsx)("button",{className:"btn outline",disabled:I||!R,onClick:()=>U("ingest",{directory:R,commit:!0,applyCorrections:!0}),children:"Ingest Directory"})]})]}),(0,l.jsx)("button",{className:"btn",disabled:I,onClick:()=>U("verify",{}),children:"Run Verify"}),(0,l.jsx)("button",{className:"btn",disabled:I,onClick:()=>U("recompute",{pushSheet:!1}),children:"Recompute Latest"}),(0,l.jsx)("button",{className:"btn",disabled:I,onClick:()=>U("recompute",{pushSheet:!0}),children:"Recompute & Push Sheet"})]}),(0,l.jsxs)("div",{className:"card",style:{marginTop:24},children:[(0,l.jsx)("h4",{style:{marginTop:0},children:"Live Logs"}),(0,l.jsx)("div",{style:{background:"rgba(15, 23, 42, 0.6)",borderRadius:8,border:"1px solid rgba(148,163,184,0.2)",padding:12,height:220,overflowY:"auto",fontFamily:"monospace",fontSize:12},children:0===P.length?(0,l.jsx)("p",{style:{opacity:.7},children:"Click a task to stream logs."}):P.map((e,t)=>(0,l.jsx)("div",{children:e},t))})]})]})]}):(0,l.jsx)("div",{className:"card",style:{padding:"2rem"},children:"Loading health metrics…"})),"uploads"===y&&u&&(0,l.jsx)(o,{guildId:u}),"sheet"===y&&u&&(0,l.jsx)(v,{guildId:u}),!u&&(0,l.jsx)("p",{children:"Select a guild to begin."}),T&&(0,l.jsx)("div",{className:"toast",style:{borderColor:"error"===T.type?"rgba(248,113,113,0.4)":void 0},children:T.message})]})}}},function(e){e.O(0,[359,754,888,774,179],function(){return e(e.s=1110)}),_N_E=e.O()}]);