(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[443],{1069:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/guilds/[guildId]",function(){return s(5739)}])},4166:function(e,t,s){"use strict";s.d(t,{Z:function(){return u}});var n=s(4246),a=s(9894),r=s.n(a),l=s(6677),i=s(7378),o=s(6e3),c=s(5682);let d=[{href:e=>"/guilds/".concat(e),label:"Dashboard"},{href:e=>"/guilds/".concat(e,"/settings"),label:"Club Settings"},{href:e=>"/guilds/".concat(e,"/channels"),label:"Channels"},{href:e=>"/guilds/".concat(e,"/personality"),label:"Personality"},{href:e=>"/guilds/".concat(e,"/corrections"),label:"Corrections"},{href:e=>"/guilds/".concat(e,"/rescan"),label:"Rescan User"},{href:e=>"/guilds/".concat(e,"/usage"),label:"Usage"}];function u(e){var t;let{guildId:s,children:a,title:u}=e,h=(0,l.useRouter)(),p=(0,c.h)(),{user:f,refresh:g}=(0,o.k)(),m=(0,i.useMemo)(()=>s?d.map(e=>{let t=e.href(s);return{...e,href:t,active:h.pathname===t}}):[],[s,h.asPath]);return(0,n.jsxs)("div",{className:"layout",children:[(0,n.jsxs)("aside",{className:"sidebar",children:[(0,n.jsxs)("div",{style:{marginBottom:32},children:[(0,n.jsx)("h1",{style:{margin:0,fontSize:22,fontWeight:700},children:"Slimy Admin"}),f&&(0,n.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[(0,n.jsxs)("span",{style:{opacity:.8,fontSize:14},children:[f.username," \xb7 ",null===(t=f.role)||void 0===t?void 0:t.toUpperCase()]}),(0,n.jsx)("button",{className:"btn outline",onClick:async()=>{try{await p("/api/auth/logout",{method:"POST"}),await g()}catch(e){console.error(e)}},children:"Logout"})]})]}),s?(0,n.jsx)("nav",{style:{display:"flex",flexDirection:"column",gap:8},children:m.map(e=>(0,n.jsx)(r(),{href:e.href,legacyBehavior:!0,children:(0,n.jsx)("a",{style:{padding:"10px 12px",borderRadius:8,background:h.asPath===e.href?"rgba(56, 189, 248, 0.15)":"transparent",border:h.asPath===e.href?"1px solid rgba(56, 189, 248, 0.4)":"1px solid transparent"},children:e.label})},e.href))}):(0,n.jsx)("p",{style:{opacity:.7},children:"Select a guild to begin."})]}),(0,n.jsxs)("main",{className:"content",children:[u&&(0,n.jsx)("h2",{style:{marginTop:0,marginBottom:24},children:u}),a]})]})}},5682:function(e,t,s){"use strict";s.d(t,{S:function(){return r},h:function(){return l}});var n=s(7378),a=s(6e3);async function r(e){let{method:t="GET",body:s,csrfToken:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=new Headers;!s||s instanceof FormData||a.set("Content-Type","application/json"),n&&t&&"GET"!==t&&a.set("x-csrf-token",n);let r=await fetch("".concat("http://localhost:3080").concat(e),{method:t,body:s?s instanceof FormData?s:JSON.stringify(s):void 0,credentials:"include",headers:a});if(204===r.status)return null;let l=(r.headers.get("content-type")||"").includes("application/json")?await r.json():await r.text();if(!r.ok)throw Error((null==l?void 0:l.error)||(null==l?void 0:l.message)||"HTTP ".concat(r.status));return l}function l(){let{csrfToken:e}=(0,a.k)();return(0,n.useCallback)(function(t){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return r(t,{...s,csrfToken:e})},[e])}},4842:function(e,t,s){"use strict";s.d(t,{O:function(){return r},S:function(){return l}});let n="http://localhost:3080";function a(e){if("string"!=typeof e)return e;try{return JSON.parse(e)}catch(t){return e}}async function r(e){let{guildId:t,taskName:s,body:a={},csrfToken:r,onEvent:i}=e,o=new Headers;o.set("Content-Type","application/json"),r&&o.set("x-csrf-token",r);let c=await fetch("".concat(n,"/api/guilds/").concat(t,"/tasks/").concat(s),{method:"POST",credentials:"include",headers:o,body:JSON.stringify(a)});if(!c.ok)throw Error("Failed to start task (".concat(c.status,")"));let{taskId:d}=await c.json();if(!d)throw Error("Task did not return a taskId");return i&&i({event:"start",data:{taskId:d}}),l(d,{onEvent:i})}function l(e){let{onEvent:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(s=>{let r=!1,l=new EventSource("".concat(n,"/api/tasks/").concat(e,"/stream"),{withCredentials:!0}),i=()=>{l.close()};l.addEventListener("log",e=>{let s=a(e.data);t&&t({event:"log",data:s})}),l.addEventListener("error",e=>{let n=a(e.data);n&&t&&t({event:"error",data:n}),l.readyState===EventSource.CLOSED&&(i(),s({status:"closed"}))}),l.addEventListener("end",e=>{let n=a(e.data);t&&t({event:"end",data:n}),i(),r||(r=!0,s(n))}),l.onerror=()=>{l.readyState!==EventSource.CLOSED||(i(),r||(r=!0,s({status:"closed"})))}})}},5739:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return p}});var n=s(4246),a=s(7378),r=s(6677),l=s(9720),i=s(4166),o=s(5682),c=s(6e3),d=s(4842);let u=e=>(0,o.S)(e);function h(e){return null==e?"—":Number(e).toLocaleString()}function p(){var e,t;let{guildId:s}=(0,r.useRouter)().query,{csrfToken:o}=(0,c.k)(),{data:p,mutate:f}=(0,l.ZP)(s?"/api/guilds/".concat(s,"/health"):null,u,{refreshInterval:6e4}),[g,m]=(0,a.useState)(null),[y,x]=(0,a.useState)([]),[v,j]=(0,a.useState)(null),[b,S]=(0,a.useState)(""),k=!!g,w=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(s&&o){m(e),x([]),j(null);try{await (0,d.O)({guildId:s,taskName:e,body:t,csrfToken:o,onEvent:t=>{var s,n;if("start"===t.event&&x(["task:".concat(e," started (id: ").concat(t.data.taskId||"unknown",")")]),"log"===t.event&&x(e=>[...e,"".concat(t.data.stream,": ").concat(t.data.line)]),"error"===t.event){let e=(null===(s=t.data)||void 0===s?void 0:s.message)||"Task error";x(t=>[...t,"stderr: ".concat(e)]),j({type:"error",message:e})}if("end"===t.event){let s=(null===(n=t.data)||void 0===n?void 0:n.status)||"completed";j({type:"completed"===s?"success":"error",message:"completed"===s?"".concat(e," completed"):"".concat(e," failed")})}}}),await f()}catch(e){j({type:"error",message:e.message})}finally{m(null)}}},N=(0,a.useMemo)(()=>s?"/guilds/".concat(s,"/usage"):"#",[s]);return(0,n.jsxs)(i.Z,{guildId:s,title:"Guild Dashboard",children:[p?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"card-grid",children:[(0,n.jsxs)("div",{className:"card",children:[(0,n.jsx)("h4",{children:"Week"}),(0,n.jsx)("p",{style:{fontSize:24},children:p.weekId||"—"}),(0,n.jsxs)("p",{style:{opacity:.7},children:["Snapshot: ",p.lastSnapshotAt||"—"]})]}),(0,n.jsxs)("div",{className:"card",children:[(0,n.jsx)("h4",{children:"Members"}),(0,n.jsx)("p",{style:{fontSize:24},children:h(p.members)}),(0,n.jsxs)("p",{style:{opacity:.7},children:["Last sheet push: ",p.lastSheetPushAt||"—"]})]}),(0,n.jsxs)("div",{className:"card",children:[(0,n.jsx)("h4",{children:"Total Power"}),(0,n.jsx)("p",{style:{fontSize:24},children:h(p.totalPower)}),(0,n.jsxs)("p",{style:{opacity:.7},children:["Threshold ",h(null===(e=p.thresholds)||void 0===e?void 0:e.low)," – ",h(null===(t=p.thresholds)||void 0===t?void 0:t.high)]})]}),(0,n.jsxs)("div",{className:"card",children:[(0,n.jsx)("h4",{children:"Sim Power"}),(0,n.jsx)("p",{style:{fontSize:24},children:h(p.simPower)}),(0,n.jsx)("p",{children:(0,n.jsx)("a",{className:"pill",href:N,children:"Usage"})})]})]}),(0,n.jsxs)("section",{style:{marginTop:40},children:[(0,n.jsx)("h3",{children:"Tasks"}),(0,n.jsxs)("div",{style:{display:"flex",gap:12,flexWrap:"wrap"},children:[(0,n.jsxs)("div",{className:"card",style:{flexBasis:"100%",background:"transparent",border:"none",padding:0},children:[(0,n.jsx)("label",{style:{display:"block",marginBottom:8},children:"Screenshot Directory"}),(0,n.jsxs)("div",{style:{display:"flex",gap:8},children:[(0,n.jsx)("input",{className:"input",placeholder:"/opt/slimy/app/screenshots/latest",value:b,onChange:e=>S(e.target.value),style:{flex:1}}),(0,n.jsx)("button",{className:"btn outline",disabled:k||!b,onClick:()=>w("ingest",{directory:b,commit:!0,applyCorrections:!0}),children:"Ingest Directory"})]})]}),(0,n.jsx)("button",{className:"btn",disabled:k,onClick:()=>w("verify",{}),children:"Run Verify"}),(0,n.jsx)("button",{className:"btn",disabled:k,onClick:()=>w("recompute",{pushSheet:!1}),children:"Recompute Latest"}),(0,n.jsx)("button",{className:"btn",disabled:k,onClick:()=>w("recompute",{pushSheet:!0}),children:"Recompute & Push Sheet"})]}),(0,n.jsxs)("div",{className:"card",style:{marginTop:24},children:[(0,n.jsx)("h4",{style:{marginTop:0},children:"Live Logs"}),(0,n.jsx)("div",{style:{background:"rgba(15, 23, 42, 0.6)",borderRadius:8,border:"1px solid rgba(148,163,184,0.2)",padding:12,height:220,overflowY:"auto",fontFamily:"monospace",fontSize:12},children:0===y.length?(0,n.jsx)("p",{style:{opacity:.7},children:"Click a task to stream logs."}):y.map((e,t)=>(0,n.jsx)("div",{children:e},t))})]})]})]}):(0,n.jsx)("p",{children:"Loading health metrics…"}),v&&(0,n.jsx)("div",{className:"toast",style:{borderColor:"error"===v.type?"rgba(248,113,113,0.4)":void 0},children:v.message})]})}}},function(e){e.O(0,[827,720,888,774,179],function(){return e(e.s=1069)}),_N_E=e.O()}]);